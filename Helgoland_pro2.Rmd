---
title: "Helgoland_pro2"
output: html_document
date: "2025-09-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)
library(gamlss)
library(knitr)

# Set the directory where your files are located
data_directory <- "dataset"

files <- list.files(path = data_directory, pattern = "\\.csv$", full.names = TRUE)
files <- files[!grepl("Helgoland_2002.csv", files)]
files <- files[!grepl("Helgoland_1998.csv", files)]

list_of_dataframes <- lapply(files, read.csv)

df <- files %>%
  lapply(read.csv) %>%
  bind_rows()


# add year as a column
df$year <- year(ymd_hm(df$Date))
df <- df %>%
  mutate(Date = as.Date(ymd_hm(Date)))

# add month as a column 
df <- df %>% 
  mutate(month = factor(format(Date, "%m")))

# create own df to remove NAs 
Nitrate <- df %>% filter(!is.na(Nitrate)) %>% 
  select(Date, Nitrate, year, month)

# create df for phytoplankton count
Phytopl <- df %>% filter(!is.na(Phytopl)) %>% 
  select(Date, Phytopl, year, month)

# create df for phytoplankton biomass
Phytopl_C <- df %>% filter(!is.na(Phytopl_C)) %>% 
  select(Date, Phytopl_C, year, month)

# create day of the year for nitrate and phytopl
Nitrate <- Nitrate %>%
  mutate(DOY  = yday(Date)) 

Phytopl <- Phytopl %>%
  mutate(DOY  = yday(Date)) 

Phytopl_C <- Phytopl_C %>%
  mutate(DOY  = yday(Date)) 
```

## Density plot for Nitrate

```{r cars, echo=FALSE}
# density plot 
ggplot(Nitrate, aes(y = Nitrate)) +
  geom_density(linewidth = 0.8) +
  geom_hline(yintercept = mean(Nitrate$Nitrate), linetype = "dashed", color = "azure4") +
  labs(
    x = "Density",
    y = "Value"
  ) +
  theme_minimal(base_size = 14) +
  coord_flip()

```

```{r models}
# Intercept model 
niSSTm <- gamlss(Nitrate ~ 1, family = SST(), data = Nitrate,
                 mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                 method = mixed(10,200),
                 control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm)

# Only mean changing through time linearly 
niSSTm2 <- gamlss(Nitrate ~ Date, family = SST(), data = Nitrate,
                  #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                  method = mixed(10,200),
                  control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm2)

# mean, sigma and nu changing through time linearly 
niSSTm3 <- gamlss(Nitrate ~ Date, sigma.fo = ~ Date, nu.fo = ~ Date, family = SST(), data = Nitrate,
                  #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                  method = mixed(10,200),
                  control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm3)

# polynomial
#niSSTpolym1 <- gamlss(Nitrate ~ poly(Date, 2), sigma.fo = ~ poly(Date, 2), nu.fo = ~ poly(Date, 2), family = SST(), data = Nitrate,
                     #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                     #method = mixed(10,200),
                     #control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTpolym1)

# mu sig and nu changing with seasonality
niSSTm3_sea <- gamlss(Nitrate ~ year + month, sigma.fo = ~ year + month, nu.fo = ~ year + month, family = SST(), data = Nitrate,
                      #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                      method = mixed(10,200),
                      control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm3_sea)
```

```{r predict seasonality, echo=FALSE}
# predict mu based on seasonaility model
Nitrate$mu_hat <- fitted(niSSTm3_sea, what = "mu")
Nitrate$sigma_hat <- fitted(niSSTm3_sea, what = "sigma")
Nitrate$nu_hat <- fitted(niSSTm3_sea, what = "nu")
Nitrate$tau_hat <- fitted(niSSTm3_sea, what = "tau")
```

## Nitrate data with models

```{r pressure, fig.width = 11, fig.height = 6, echo=FALSE}
# plot that sucka (intercept model)
ggplot(Nitrate, aes(x = Date, y = Nitrate)) +
  geom_line(color = "grey", na.rm = TRUE) +
  geom_line(aes(y = mu_hat), color = "darkolivegreen", linewidth = 1) +
  geom_abline(intercept = niSSTm2$mu.coefficients[1], slope = niSSTm2$mu.coefficients[2], 
              color = "steelblue", linewidth = 2) + # only mean as function of time 
  geom_abline(intercept = niSSTm3$mu.coefficients[1], slope = niSSTm3$mu.coefficients[2], 
              color = "goldenrod", linewidth = 2) + # mean, sigma and nu as function of time
  #geom_abline(intercept = niNOm1$mu.coefficients[1], slope = niNOm1$mu.coefficients[2], 
  #color = "darkolivegreen", linewidth = 1) + # mean, sigma and nu as function of time
  #geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE, color = "salmon") +
  geom_hline(yintercept = 16.718, linetype = "dashed", color = "black", linewidth = 1) + # intercept mean
  geom_vline(xintercept = as.Date("1963-09-23"), linetype = "dashed", color = "darkred") + 
  geom_vline(xintercept = as.Date("1980-09-23"), linetype = "dashed", color = "darkred") + 
  geom_vline(xintercept = as.Date("1994-09-23"), linetype = "dashed", color = "darkred") +
  labs(x = "Time", y = "Nitrate (µmol/l)") +
  theme_classic()
```

```{r echo=FALSE}
# function for pdf 
pdf_SST_at_date <- function(model, data, date_str, x = NULL, n = 200,
                            time_var = "Date", date_var = "Date") {
  # 1. Find the row in df matching the date of interest
  t_val <- data[[time_var]][as.Date(data[[date_var]]) == as.Date(date_str)]
  if (length(t_val) == 0) stop("Date not found in data frame.")
  
  # 2. Build newdata with the correct covariate
  newdat <- data.frame(setNames(list(t_val), time_var))
  
  # 3. Predict distribution parameters on natural scale
  mu    <- predict(model, "mu",    newdata = newdat, type = "response")
  sigma <- predict(model, "sigma", newdata = newdat, type = "response")
  nu    <- predict(model, "nu",    newdata = newdat, type = "response")
  tau   <- predict(model, "tau",   newdata = newdat, type = "response")
  
  # 4. Create x grid if none supplied
  if (is.null(x)) {
    x <- seq(min(model$y, na.rm = TRUE),
             max(model$y, na.rm = TRUE),
             length.out = n)
  }
  
  # 5. Evaluate PDF
  dens <- dSST(x, mu = mu, sigma = sigma, nu = nu, tau = tau)
  
  list(x = x, density = dens,
       params = c(mu = mu, sigma = sigma, nu = nu, tau = tau))
}

# get the pdf and param for three dates
# m1 (intercept model)
resm1 <- pdf_SST_at_date(niSSTm, Nitrate, "1963-09-23",
                         time_var = "Date", date_var = "Date")
resm1b <- pdf_SST_at_date(niSSTm, Nitrate, "1980-09-23",
                          time_var = "Date", date_var = "Date")
resm1c <- pdf_SST_at_date(niSSTm, Nitrate, "1994-09-23",
                          time_var = "Date", date_var = "Date")
# m2 (mean only)
resm2 <- pdf_SST_at_date(niSSTm2, Nitrate, "1963-09-23",
                         time_var = "Date", date_var = "Date")
resm2b <- pdf_SST_at_date(niSSTm2, Nitrate, "1980-09-23",
                          time_var = "Date", date_var = "Date")
resm2c <- pdf_SST_at_date(niSSTm2, Nitrate, "1994-09-23",
                          time_var = "Date", date_var = "Date")
# m3 (mean sigma and nu)
resm3 <- pdf_SST_at_date(niSSTm3, Nitrate, "1963-09-23",
                         time_var = "Date", date_var = "Date")
resm3b <- pdf_SST_at_date(niSSTm3, Nitrate, "1980-09-23",
                          time_var = "Date", date_var = "Date")
resm3c <- pdf_SST_at_date(niSSTm3, Nitrate, "1994-09-23",
                          time_var = "Date", date_var = "Date")
# pdf for seasonaility model
x <- seq(min(niSSTm3_sea$y, na.rm = TRUE),
         max(niSSTm3_sea$y, na.rm = TRUE),
         length.out = 200)

pdf_1963 <- dSST(x, mu = 1.2156707, sigma = 3.290147, nu = 9.663093, tau = 6.874041)
pdf_1980 <- dSST(x, mu = 8.671901, sigma = 6.657359, nu = 7.422281, tau = 6.874041)
pdf_1994 <- dSST(x, mu = 14.81233, sigma = 11.89524, nu = 5.9728054, tau = 6.874041)

```

## PDF for three random dates

```{r pdf for each dates, fig.width = 12, fig.height = 6, echo=FALSE}
par(mfrow = c(1, 3)) 
# plot the models together for date 1: 1963-09-23
plot(resm1$x, resm1$density, col = "black", type = "l", lwd = 3, lty = 2, ylim=c(0,0.15),
     ylab = "Density", xlab = "Value",
     main = "1963-09-23") # intercept model
lines(resm2$x, resm2$density, col = "steelblue", lwd = 3, lty = 1) # mean only model
lines(resm3$x, resm3$density, col = "goldenrod",lwd = 3, lty = 1) # mean sigma and nu 
lines(x, pdf_1963, col = "darkolivegreen", lwd = 3, lty = 1)# seasonaility model
legend("topright", legend = c("Intercept", "mean(time)", "all param(time)", "seasonality"),
       col = c("black", "steelblue", "goldenrod", "darkolivegreen"), cex = 1.4, lty = c(2,1,1,1), bty = "n")
# plot the models together for date 2: 1980-09-23
plot(resm1b$x, resm1b$density, col = "black", type = "l", lwd = 3, lty = 2, ylim=c(0,0.15),
     ylab = "Density", xlab = "Value",
     main = "1980-09-23") # intercept model
lines(resm2b$x, resm2b$density, col = "steelblue", lwd = 3, lty = 1) # mean only model
lines(resm3b$x, resm3b$density, col = "goldenrod",lwd = 3, lty = 1) # mean sigma an nu 
lines(x, pdf_1980, col = "darkolivegreen", lwd = 3, lty = 1)# seasonaility model
legend("topright", legend = c("Intercept", "mean(time)", "all param(time)", "seasonality"),
       col = c("black", "steelblue", "goldenrod",  "darkolivegreen"), cex = 1.4, lty = c(2,1,1,1), bty = "n")
# plot the models together for date 3: 1994-09-23
plot(resm1c$x, resm1c$density, col = "black", type = "l", lwd = 3, lty =2, ylim=c(0,0.15),
     ylab = "Density", xlab = "Value",
     main = "1994-09-23") # intercept model
lines(resm2c$x, resm2c$density, col = "steelblue", lwd = 3, lty = 1) # mean only model
lines(resm3c$x, resm3c$density, col = "goldenrod",lwd = 3, lty = 1) # mean sigma and nu 
lines(x, pdf_1994, col = "darkolivegreen", lwd = 3, lty = 1)# seasonaility model
legend("topright", legend = c("Intercept", "mean(time)", "all param(time)", "seasonality"),
       col = c("black", "steelblue", "goldenrod",  "darkolivegreen"), cex = 1.4, lty = c(2,1,1,1), bty = "n")
par(mfrow = c(1,1)) # reset
```

### 1963-09-23
```{r echo=FALSE}
param_table <- data.frame(
  models = c("Intercept", "Mean(time)", "All_param(time)", "Seasonality"),
  mu = c(resm1$params[1], resm2$params[1],resm3$params[1],  Nitrate[242,6]),
  sigma = c(resm1$params[2], resm2$params[2], resm3$params[2], Nitrate[242,7]),
  nu = c(resm1$params[3], resm2$params[3], resm3$params[3], Nitrate[242,8]),
  tau = c(resm1$params[4], resm2$params[4], resm3$params[4], Nitrate[242,9])
)

param_table %>%
  kable(caption = "Predicted parameters for 1963-09-23")
```

### 1980-09-23
```{r echo=FALSE}
param_table <- data.frame(
  models = c("Intercept", "Mean(time)", "All_param(time)", "Seasonality"),
  mu = c(resm1b$params[1], resm2b$params[1],resm3b$params[1],  Nitrate[3025,6]),
  sigma = c(resm1b$params[2], resm2b$params[2], resm3b$params[2], Nitrate[3025,7]),
  nu = c(resm1b$params[3], resm2b$params[3], resm3b$params[3], Nitrate[3025,8]),
  tau = c(resm1b$params[4], resm2b$params[4], resm3b$params[4], Nitrate[3025,9])
)

param_table %>%
  kable(caption = "Predicted parameters for 1980-09-23")
```

### 1994-09-23
```{r echo=FALSE}
param_table <- data.frame(
  models = c("Intercept", "Mean(time)", "All_param(time)", "Seasonality"),
  mu = c(resm1c$params[1], resm2c$params[1],resm3c$params[1],  Nitrate[6435,6]),
  sigma = c(resm1c$params[2], resm2c$params[2], resm3c$params[2], Nitrate[6435,7]),
  nu = c(resm1c$params[3], resm2c$params[3], resm3c$params[3], Nitrate[6435,8]),
  tau = c(resm1c$params[4], resm2c$params[4], resm3c$params[4], Nitrate[6435,9])
)

param_table %>%
  kable(caption = "Predicted parameters for 1994-04-13")
```

<br>

## Seasonality model; patterns in months

```{r, fig.width = 12, fig.height = 6, echo=FALSE}
# look at seasoanility of same months different year 
# 1963
pdf_1963_Apr <- dSST(x, mu = 17.8164808, sigma = 6.879606, nu = 1.509802, tau = 6.874041) # April
pdf_1963_Aug <- dSST(x, mu = 0.8980581, sigma = 3.253148, nu = 9.926294, tau = 6.874041) # August
pdf_1963_Dec <- dSST(x, mu = 5.6005733, sigma = 4.221979, nu = 2.678465, tau = 6.874041) # December
# 1980
pdf_1980_Apr <- dSST(x, mu = 25.272711, sigma = 13.920353, nu = 1.159688, tau = 6.874041) # April
pdf_1980_Aug <- dSST(x, mu = 8.354289, sigma = 6.582495, nu = 7.624447, tau = 6.874041) # August
pdf_1980_Dec <- dSST(x, mu = 13.056804, sigma = 8.542849, nu = 2.057345, tau = 6.874041) # December
## 1994
pdf_1994_Apr <- dSST(x, mu = 31.41314, sigma = 24.87263, nu = 0.9332162, tau = 6.874041) # April
pdf_1994_Aug <- dSST(x, mu = 14.49471, sigma = 11.76148, nu = 6.1354915, tau = 6.874041) # August
pdf_1994_Dec <- dSST(x, mu = 19.19723, sigma = 15.26420, nu = 1.6555721, tau = 6.874041) # December


par(mfrow = c(1, 3)) 
# plot the models together for date month of April
plot(x, pdf_1963_Apr, col = "chocolate", type = "l", lwd = 2, ylim=c(0,0.14),
     ylab = "Density", xlab = "Value",
     main = "April") # 1963
lines(x, pdf_1980_Apr, col = "cornflowerblue", lwd = 2) # 1980
lines(x, pdf_1994_Apr, col = "darkseagreen4",lwd = 2) # 1994
legend("topright", legend = c("1963", "1980", "1994"),
       col = c("chocolate", "cornflowerblue", "darkseagreen4"), cex = 1.4, lty = c(1,1,1), bty = "n")
# plot the models together for month August
plot(x, pdf_1963_Aug, col = "chocolate", type = "l", lwd = 2, ylim=c(0,0.14),
      ylab = "Density", xlab = "Value",
      main = "August") # 1963
lines(x, pdf_1980_Aug, col = "cornflowerblue", lwd = 2) # 1980
lines(x, pdf_1994_Aug, col = "darkseagreen4",lwd = 2) # 1994
legend("topright", legend = c("1963", "1980", "1994"),
       col = c("chocolate", "cornflowerblue", "darkseagreen4"), cex = 1.4, lty = c(1,1,1), bty = "n")
# plot the models together for month December
plot(x, pdf_1963_Dec, col = "chocolate", type = "l", lwd = 2, ylim=c(0,0.14),
      ylab = "Density", xlab = "Value",
      main = "December") # 1963
lines(x, pdf_1980_Dec, col = "cornflowerblue", lwd = 2) # 1980
lines(x, pdf_1994_Dec, col = "darkseagreen4",lwd = 2) # 1994
legend("topright", legend = c("1963", "1980", "1994"),
       col = c("chocolate", "cornflowerblue", "darkseagreen4"), cex = 1.4, lty = c(1,1,1), bty = "n")
par(mfrow = c(1,1)) # reset
```

### April
```{r echo=FALSE}
param_table <- data.frame(
  models = c("1963", "1980", "1994"),
  mu = c(Nitrate[169,6], Nitrate[2906,6], Nitrate[6317,6]),
  sigma = c(Nitrate[169,7], Nitrate[2906,7], Nitrate[6317,7]),
  nu = c(Nitrate[169,8], Nitrate[2906,8], Nitrate[6317,8]),
  tau = c(Nitrate[169,9], Nitrate[2906,9], Nitrate[6317,9])
)

param_table %>%
  kable(caption = "Predicted parameters for April")
```

### August
```{r echo=FALSE}
param_table <- data.frame(
  models = c("1963", "1980", "1994"),
  mu = c(Nitrate[221,6], Nitrate[2988,6], Nitrate[6398,6]),
  sigma = c(Nitrate[221,7], Nitrate[2988,7], Nitrate[6398,7]),
  nu = c(Nitrate[221,8], Nitrate[2988,8], Nitrate[6398,8]),
  tau = c(Nitrate[221,9], Nitrate[2988,9], Nitrate[6398,9])
)

param_table %>%
  kable(caption = "Predicted parameters for August")
```

### December
```{r echo=FALSE}
param_table <- data.frame(
  models = c("1963", "1980", "1994"),
  mu = c(Nitrate[270,6], Nitrate[3073,6], Nitrate[6478,6]),
  sigma = c(Nitrate[270,7], Nitrate[3073,7], Nitrate[6478,7]),
  nu = c(Nitrate[270,8], Nitrate[3073,8], Nitrate[6478,8]),
  tau = c(Nitrate[270,9], Nitrate[3073,9], Nitrate[6478,9])
)

param_table %>%
  kable(caption = "Predicted parameters for December")
```

<br> 

```{r, fig.width = 11, fig.height = 6, echo=FALSE}
# look at nitrate patterns for different years 
years_to_plot <- c(1963, 1975, 1980, 1966, 1994, 1962, 1978, 1992)
main_years_to_plot <- c(1963, 1980, 1994)

# plot that sucka
ggplot(Nitrate %>% filter(year %in% years_to_plot),
       aes(x = DOY, y = Nitrate, color = factor(year))) +
  geom_line() +
  scale_colour_manual(values = c("1963" = "chocolate",
                                 "1980" = "cornflowerblue",
                                 "1994" = "darkseagreen4",
                                 "Other" = "grey70")) + 
  geom_vline(xintercept = 355, linetype = "dashed") + # start of winter
  geom_vline(xintercept = 80, linetype = "dashed") + # start of spring
  geom_vline(xintercept = 173, linetype = "dashed") + # start of summer
  geom_vline(xintercept = 266, linetype = "dashed") + # start of fall
  annotate("text", x = 37, y = 145, label = "Winter", size = 4) +
  annotate("text", x = 130, y = 145, label = "Spring", size = 4) +
  annotate("text", x = 220, y = 145, label = "Summer", size = 4) +
  annotate("text", x = 315, y = 145, label = "Fall", size = 4) +
  labs(x = "", y = "Nitrate (µmol/l)", colour = "Year") +
  theme_classic()

# plot phytoplankton count
ggplot(Phytopl %>% filter(year %in% main_years_to_plot),
       aes(x = DOY, y = Phytopl, color = factor(year))) +
  geom_line() +
  scale_colour_manual(values = c("1963" = "chocolate",
                                 "1980" = "cornflowerblue",
                                 "1994" = "darkseagreen4")) + 
  geom_vline(xintercept = 355, linetype = "dashed") + # start of winter
  geom_vline(xintercept = 80, linetype = "dashed") + # start of spring
  geom_vline(xintercept = 173, linetype = "dashed") + # start of summer
  geom_vline(xintercept = 266, linetype = "dashed") + # start of fall
  annotate("text", x = 37, y = 3000000, label = "Winter", size = 4) +
  annotate("text", x = 130, y = 3000000, label = "Spring", size = 4) +
  annotate("text", x = 220, y = 3000000, label = "Summer", size = 4) +
  annotate("text", x = 315, y = 3000000, label = "Fall", size = 4) +
  labs(x = "", y = "Phytoplankton count", colour = "Year") +
  theme_classic()

# plot phytoplankton biomass
ggplot(Phytopl_C %>% filter(year %in% main_years_to_plot),
       aes(x = DOY, y = Phytopl_C, color = factor(year))) +
  geom_line() +
  scale_colour_manual(values = c("1963" = "chocolate",
                                 "1980" = "cornflowerblue",
                                 "1994" = "darkseagreen4")) + 
  geom_vline(xintercept = 355, linetype = "dashed") + # start of winter
  geom_vline(xintercept = 80, linetype = "dashed") + # start of spring
  geom_vline(xintercept = 173, linetype = "dashed") + # start of summer
  geom_vline(xintercept = 266, linetype = "dashed") + # start of fall
  annotate("text", x = 37, y = 500, label = "Winter", size = 4) +
  annotate("text", x = 130, y = 500, label = "Spring", size = 4) +
  annotate("text", x = 220, y = 500, label = "Summer", size = 4) +
  annotate("text", x = 315, y = 500, label = "Fall", size = 4) +
  labs(x = "Day of Year", y = "Phytoplankton biomass", colour = "Year") +
  theme_classic()

```

<br> 

## Simulation 

```{r echo=FALSE}
n        <- 6000
t_index  <- seq_len(n)
mu0       <- 16
sigma0   <- 15
nu0      <- 10
tau0     <- 4

# seasonality pattern
set.seed(1234)
n <- 6000
t_index  <- seq_len(n)
mu0       <- 16
sigma0   <- 15
nu0      <- 10
tau0     <- 4

# changing rate
beta1 <- 0.6
beta2 <- 0.4
cov1 <- sin(2*pi*(1:TT)/12)
cov2 <- cos(2*pi*(1:TT)/12)
yt <- beta1*cov1 + beta2*cov2
plot(yt, type="l", xlab="t")
  
# changes with time
mu_t <- 16 
sigma_t 
nu_t


```


