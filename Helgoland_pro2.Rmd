---
title: "Helgoland_pro2"
output: html_document
date: "2025-09-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)
library(gamlss)
library(knitr)

# Set the directory where your files are located
data_directory <- "dataset"

files <- list.files(path = data_directory, pattern = "\\.csv$", full.names = TRUE)
files <- files[!grepl("Helgoland_2002.csv", files)]
files <- files[!grepl("Helgoland_1998.csv", files)]

list_of_dataframes <- lapply(files, read.csv)

df <- files %>%
  lapply(read.csv) %>%
  bind_rows()


# add year as a column
df$year <- year(ymd_hm(df$Date))
df <- df %>%
  mutate(Date = as.Date(ymd_hm(Date)))

# add month as a column 
df <- df %>% 
  mutate(month = factor(format(Date, "%m")))

# create own df to remove NAs 
Nitrate <- df %>% filter(!is.na(Nitrate)) %>% 
  select(Date, Nitrate, year, month)
```

## Density plot for Nitrate

```{r cars, echo=FALSE}
# density plot 
ggplot(Nitrate, aes(y = Nitrate)) +
  geom_density(linewidth = 0.8) +
  geom_hline(yintercept = mean(Nitrate$Nitrate), linetype = "dashed", color = "azure4") +
  labs(
    x = "Density",
    y = "Value"
  ) +
  theme_minimal(base_size = 14) +
  coord_flip()

```

```{r models}
# Intercept model 
niSSTm <- gamlss(Nitrate ~ 1, family = SST(), data = Nitrate,
                 mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                 method = mixed(10,200),
                 control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm)

# Only mean changing through time linearly 
niSSTm2 <- gamlss(Nitrate ~ Date, family = SST(), data = Nitrate,
                  #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                  method = mixed(10,200),
                  control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm2)

# mean, sigma and nu changing through time linearly 
niSSTm3 <- gamlss(Nitrate ~ Date, sigma.fo = ~ Date, nu.fo = ~ Date, family = SST(), data = Nitrate,
                  #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                  method = mixed(10,200),
                  control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm3)

# polynomial
#niSSTpolym1 <- gamlss(Nitrate ~ poly(Date, 2), sigma.fo = ~ poly(Date, 2), nu.fo = ~ poly(Date, 2), family = SST(), data = Nitrate,
                     #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                     #method = mixed(10,200),
                     #control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTpolym1)

# mu sig and nu changing with seasonality
niSSTm3_sea <- gamlss(Nitrate ~ year + month, sigma.fo = ~ year + month, nu.fo = ~ year + month, family = SST(), data = Nitrate,
                      #mu.start = mean(Nitrate$Nitrate), sigma.start = sd(Nitrate$Nitrate),
                      method = mixed(10,200),
                      control = gamlss.control(n.cyc = 200, c.crit = 0.01, trace = FALSE))
#summary(niSSTm3_sea)
```

```{r predict seasonality, echo=FALSE}
# predict mu based on seasonaility model
Nitrate$mu_hat <- fitted(niSSTm3_sea, what = "mu")
Nitrate$sigma_hat <- fitted(niSSTm3_sea, what = "sigma", type = "response")
Nitrate$nu_hat <- fitted(niSSTm3_sea, what = "nu", type = "response")
Nitrate$tau_hat <- fitted(niSSTm3_sea, what = "tau", type = "response")
```

## Nitrate data with models

```{r pressure, fig.width = 12, fig.height = 6, echo=FALSE}
# plot that sucka (intercept model)
ggplot(Nitrate, aes(x = Date, y = Nitrate)) +
  geom_line(color = "grey", na.rm = TRUE) +
  geom_line(aes(y = mu_hat), color = "darkolivegreen", linewidth = 1) +
  geom_abline(intercept = niSSTm2$mu.coefficients[1], slope = niSSTm2$mu.coefficients[2], 
              color = "steelblue", linewidth = 2) + # only mean as function of time 
  geom_abline(intercept = niSSTm3$mu.coefficients[1], slope = niSSTm3$mu.coefficients[2], 
              color = "goldenrod", linewidth = 2) + # mean, sigma and nu as function of time
  #geom_abline(intercept = niNOm1$mu.coefficients[1], slope = niNOm1$mu.coefficients[2], 
  #color = "darkolivegreen", linewidth = 1) + # mean, sigma and nu as function of time
  #geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE, color = "salmon") +
  geom_hline(yintercept = 16.718, linetype = "dashed", color = "black", linewidth = 2) + # intercept mean
  geom_vline(xintercept = as.Date("1963-09-23"), linetype = "dashed", color = "darkred") + 
  geom_vline(xintercept = as.Date("1980-09-23"), linetype = "dashed", color = "darkred") + 
  geom_vline(xintercept = as.Date("1994-04-13"), linetype = "dashed", color = "darkred") +
  labs(x = "Time", y = "Nitrate (Âµmol/l)") +
  theme_classic()
```

```{r echo=FALSE}
# function for pdf 
pdf_SST_at_date <- function(model, data, date_str, x = NULL, n = 200,
                            time_var = "Date", date_var = "Date") {
  # 1. Find the row in df matching the date of interest
  t_val <- data[[time_var]][as.Date(data[[date_var]]) == as.Date(date_str)]
  if (length(t_val) == 0) stop("Date not found in data frame.")
  
  # 2. Build newdata with the correct covariate
  newdat <- data.frame(setNames(list(t_val), time_var))
  
  # 3. Predict distribution parameters on natural scale
  mu    <- predict(model, "mu",    newdata = newdat, type = "response")
  sigma <- predict(model, "sigma", newdata = newdat, type = "response")
  nu    <- predict(model, "nu",    newdata = newdat, type = "response")
  tau   <- predict(model, "tau",   newdata = newdat, type = "response")
  
  # 4. Create x grid if none supplied
  if (is.null(x)) {
    x <- seq(min(model$y, na.rm = TRUE),
             max(model$y, na.rm = TRUE),
             length.out = n)
  }
  
  # 5. Evaluate PDF
  dens <- dSST(x, mu = mu, sigma = sigma, nu = nu, tau = tau)
  
  list(x = x, density = dens,
       params = c(mu = mu, sigma = sigma, nu = nu, tau = tau))
}

# get the pdf and param for three dates
# m1 (intercept model)
resm1 <- pdf_SST_at_date(niSSTm, Nitrate, "1963-09-23",
                         time_var = "Date", date_var = "Date")
resm1b <- pdf_SST_at_date(niSSTm, Nitrate, "1980-09-23",
                          time_var = "Date", date_var = "Date")
resm1c <- pdf_SST_at_date(niSSTm, Nitrate, "1994-04-13",
                          time_var = "Date", date_var = "Date")
# m2 (mean only)
resm2 <- pdf_SST_at_date(niSSTm2, Nitrate, "1963-09-23",
                         time_var = "Date", date_var = "Date")
resm2b <- pdf_SST_at_date(niSSTm2, Nitrate, "1980-09-23",
                          time_var = "Date", date_var = "Date")
resm2c <- pdf_SST_at_date(niSSTm2, Nitrate, "1994-04-13",
                          time_var = "Date", date_var = "Date")
# m3 (mean sigma and nu)
resm3 <- pdf_SST_at_date(niSSTm3, Nitrate, "1963-09-23",
                         time_var = "Date", date_var = "Date")
resm3b <- pdf_SST_at_date(niSSTm3, Nitrate, "1980-09-23",
                          time_var = "Date", date_var = "Date")
resm3c <- pdf_SST_at_date(niSSTm3, Nitrate, "1994-04-13",
                          time_var = "Date", date_var = "Date")
# pdf for seasonaility model
x <- seq(min(niSSTm3_sea$y, na.rm = TRUE),
         max(niSSTm3_sea$y, na.rm = TRUE),
         length.out = 200)

pdf_1963 <- dSST(x, mu = 1.2156707, sigma = 3.290147, nu = 9.663093, tau = 6.874041)
pdf_1980 <- dSST(x, mu = 8.671901, sigma = 6.657359, nu = 7.422281, tau = 6.874041)
pdf_1994 <- dSST(x, mu = 31.41314, sigma = 24.87263, nu = 0.9332162, tau = 6.874041)

```

## PDF for three random dates

```{r pdf for each dates, fig.width = 12, fig.height = 6, echo=FALSE}
par(mfrow = c(1, 3)) 
# plot the models together for date 1: 1963-09-23
plot(resm1$x, resm1$density, col = "black", type = "l", lwd = 3, lty = 2, ylim=c(0,0.15),
     ylab = "Density", xlab = "Value",
     main = "1963-09-23") # intercept model
lines(resm2$x, resm2$density, col = "steelblue", lwd = 3, lty = 1) # mean only model
lines(resm3$x, resm3$density, col = "goldenrod",lwd = 3, lty = 1) # mean sigma and nu 
lines(x, pdf_1963, col = "darkolivegreen", lwd = 3, lty = 1)# seasonaility model
legend("topright", legend = c("Intercept model", "mean(time) only model", "mean(time), sigma(time) & nu(time) model"),
       col = c("black", "steelblue", "goldenrod", "darkolivegreen"), cex = 0.7, lty = c(2,1,1,1), bty = "n")
# plot the models together for date 2: 1980-09-23
plot(resm1b$x, resm1b$density, col = "black", type = "l", lwd = 3, lty = 2, ylim=c(0,0.15),
     ylab = "Density", xlab = "Value",
     main = "1980-09-03") # intercept model
lines(resm2b$x, resm2b$density, col = "steelblue", lwd = 3, lty = 1) # mean only model
lines(resm3b$x, resm3b$density, col = "goldenrod",lwd = 3, lty = 1) # mean sigma an nu 
lines(x, pdf_1980, col = "darkolivegreen", lwd = 3, lty = 1)# seasonaility model
legend("topright", legend = c("Intercept model", "mean(time) only model", "mean(time), sigma(time) & nu(time) model"),
       col = c("black", "steelblue", "goldenrod",  "darkolivegreen"), cex = 0.7, lty = c(2,1,1,1), bty = "n")
# plot the models together for date 3: 1994-04-13
plot(resm1c$x, resm1c$density, col = "black", type = "l", lwd = 3, lty =2, ylim=c(0,0.15),
     ylab = "Density", xlab = "Value",
     main = "1994-04-13") # intercept model
lines(resm2c$x, resm2c$density, col = "steelblue", lwd = 3, lty = 1) # mean only model
lines(resm3c$x, resm3c$density, col = "goldenrod",lwd = 3, lty = 1) # mean sigma and nu 
lines(x, pdf_1994, col = "darkolivegreen", lwd = 3, lty = 1)# seasonaility model
legend("topright", legend = c("Intercept model", "mean(time) only model", "mean(time), sigma(time) & nu(time) model"),
       col = c("black", "steelblue", "goldenrod",  "darkolivegreen"), cex = 0.7, lty = c(2,1,1,1), bty = "n")
par(mfrow = c(1,1)) # reset
```

### 1963-09-23
```{r echo=FALSE}
param_table <- data.frame(
  models = c("Intercept", "Mean(time)", "All_param(time)", "Seasonality"),
  mu = c(resm1$params[1], resm2$params[1],resm3$params[1],  Nitrate[242,5]),
  sigma = c(resm1$params[2], resm2$params[2], resm3$params[2], Nitrate[242,6]),
  nu = c(resm1$params[3], resm2$params[3], resm3$params[3], Nitrate[242,7]),
  tau = c(resm1$params[4], resm2$params[4], resm3$params[4], Nitrate[242,8])
)

param_table %>%
  kable(caption = "Predicted parameters for 1963-09-23")
```

### 1980-09-23
```{r echo=FALSE}
param_table <- data.frame(
  models = c("Intercept", "Mean(time)", "All_param(time)", "Seasonality"),
  mu = c(resm1b$params[1], resm2b$params[1],resm3b$params[1],  Nitrate[3025,5]),
  sigma = c(resm1b$params[2], resm2b$params[2], resm3b$params[2], Nitrate[3025,6]),
  nu = c(resm1b$params[3], resm2b$params[3], resm3b$params[3], Nitrate[3025,7]),
  tau = c(resm1b$params[4], resm2b$params[4], resm3b$params[4], Nitrate[3025,8])
)

param_table %>%
  kable(caption = "Predicted parameters for 1980-09-23")
```

### 1994-04-13
```{r echo=FALSE}
param_table <- data.frame(
  models = c("Intercept", "Mean(time)", "All_param(time)", "Seasonality"),
  mu = c(resm1c$params[1], resm2c$params[1],resm3c$params[1],  Nitrate[6323,5]),
  sigma = c(resm1c$params[2], resm2c$params[2], resm3c$params[2], Nitrate[6323,6]),
  nu = c(resm1c$params[3], resm2c$params[3], resm3c$params[3], Nitrate[6323,7]),
  tau = c(resm1c$params[4], resm2c$params[4], resm3c$params[4], Nitrate[6323,8])
)

param_table %>%
  kable(caption = "Predicted parameters for 1994-04-13")
```


